<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF Metadata Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.drag-over {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .image-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .image-remove:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }

        .image-view {
            position: absolute;
            bottom: 8px;
            right: 8px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }

        .image-card:hover .image-view {
            opacity: 1;
        }

        .image-view:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.05);
        }

        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .image-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-card-footer {
            padding: 12px;
            text-align: center;
        }

        .image-card-footer label {
            font-size: 0.9em;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        #map {
            height: 400px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            margin-top: 15px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="date"],
        input[type="time"] {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input[type="date"]:focus,
        input[type="time"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .coordinates-display {
            background: #f8f9ff;
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #fileInput {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .selection-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .selection-buttons .btn {
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📸 EXIF Metadata Editor</h1>
            <p>Upload images, set location and date, then download with updated metadata</p>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="section">
                <div class="section-title">1. Upload Images</div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📤</div>
                    <p style="font-size: 1.1em; margin-bottom: 10px;">Click or drag images here</p>
                    <p style="color: #666; font-size: 0.9em;">Supports JPG and PNG formats</p>
                </div>
                <input type="file" id="fileInput" accept=".jpg,.jpeg,.png" multiple>
            </div>

            <!-- Images Grid -->
            <div class="section" id="imagesSection" style="display: none;">
                <div class="section-title">Your Images</div>
                <div class="selection-buttons">
                    <button class="btn" id="selectAllBtn">Select All</button>
                    <button class="btn btn-secondary" id="deselectAllBtn">Deselect All</button>
                    <button class="btn btn-danger" id="removeBtn" disabled>Remove Selected</button>
                </div>
                <div class="images-grid" id="imagesGrid"></div>
            </div>

            <!-- Location Section -->
            <div class="section" id="locationSection" style="display: none;">
                <div class="section-title">2. Select Location</div>
                <p style="color: #666; margin-bottom: 10px;">Click on the map to set GPS coordinates</p>
                <div id="map"></div>
                <div class="coordinates-display" id="coordinatesDisplay" style="margin-top: 15px; display: none;">
                    No location selected
                </div>
            </div>

            <!-- Date Section -->
            <div class="section" id="dateSection" style="display: none;">
                <div class="section-title">3. Select Date & Time</div>
                <div class="input-group">
                    <input type="date" id="dateInput">
                    <input type="time" id="timeInput">
                </div>
            </div>

            <!-- Actions Section -->
            <div class="section" id="actionsSection" style="display: none;">
                <div class="section-title">4. Apply & Download</div>
                <div class="action-buttons">
                    <button class="btn" id="applyBtn" disabled>Apply Changes</button>
                    <button class="btn btn-secondary" id="downloadBtn" disabled>Download Selected Images</button>
                </div>
                <div id="statusMessage"></div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <button class="modal-close" id="modalClose">×</button>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Full size image">
        </div>
    </div>

    <script>
        // State management
        let images = [];
        let selectedLocation = null;
        let map = null;
        let marker = null;
        let lastSelectedIndex = -1;

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagesSection = document.getElementById('imagesSection');
        const imagesGrid = document.getElementById('imagesGrid');
        const locationSection = document.getElementById('locationSection');
        const dateSection = document.getElementById('dateSection');
        const actionsSection = document.getElementById('actionsSection');
        const dateInput = document.getElementById('dateInput');
        const timeInput = document.getElementById('timeInput');
        const coordinatesDisplay = document.getElementById('coordinatesDisplay');
        const applyBtn = document.getElementById('applyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const removeBtn = document.getElementById('removeBtn');
        const statusMessage = document.getElementById('statusMessage');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalClose = document.getElementById('modalClose');

        // Initialize date to today and time to 00:00
        dateInput.valueAsDate = new Date();
        timeInput.value = '00:00';

        // Upload area click
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files).filter(f => 
                f.type === 'image/jpeg' || f.type === 'image/png'
            );
            handleFiles(files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFiles(Array.from(e.target.files));
        });

        // Handle uploaded files
        function handleFiles(files) {
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    images.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        data: e.target.result,
                        originalData: e.target.result,
                        selected: false,
                        modified: false
                    });
                    renderImages();
                    showSections();
                };
                reader.readAsDataURL(file);
            });
        }

        // Render images grid
        function renderImages() {
            if (images.length === 0) {
                imagesSection.style.display = 'none';
                locationSection.style.display = 'none';
                dateSection.style.display = 'none';
                actionsSection.style.display = 'none';
                return;
            }

            imagesSection.style.display = 'block';
            imagesGrid.innerHTML = images.map((img, index) => `
                <div class="image-card ${img.selected ? 'selected' : ''}" data-id="${img.id}" data-index="${index}">
                    <button class="image-remove" data-id="${img.id}" title="Remove image">×</button>
                    <button class="image-view" data-id="${img.id}" title="View full size">👁 View</button>
                    <img src="${img.data}" alt="${img.name}">
                    <div class="image-card-footer">
                        <label title="${img.name}">${img.name}</label>
                    </div>
                </div>
            `).join('');

            // Add click handlers for image selection
            document.querySelectorAll('.image-card').forEach(card => {
                const imgElement = card.querySelector('img');
                const removeBtn = card.querySelector('.image-remove');
                const viewBtn = card.querySelector('.image-view');
                
                // Single click to select
                card.addEventListener('click', (e) => {
                    // Don't select if clicking the remove or view button
                    if (e.target === removeBtn || removeBtn.contains(e.target) ||
                        e.target === viewBtn || viewBtn.contains(e.target)) {
                        return;
                    }
                    
                    const id = parseFloat(card.getAttribute('data-id'));
                    const index = parseInt(card.getAttribute('data-index'));
                    
                    // Shift+click for range selection
                    if (e.shiftKey && lastSelectedIndex !== -1) {
                        const start = Math.min(lastSelectedIndex, index);
                        const end = Math.max(lastSelectedIndex, index);
                        
                        for (let i = start; i <= end; i++) {
                            images[i].selected = true;
                        }
                        renderImages();
                    } else {
                        // Regular click to toggle selection
                        const img = images.find(i => i.id === id);
                        if (img) {
                            img.selected = !img.selected;
                            lastSelectedIndex = img.selected ? index : -1;
                            renderImages();
                        }
                    }
                    updateButtons();
                });
                
                // View button handler
                viewBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseFloat(viewBtn.getAttribute('data-id'));
                    const img = images.find(i => i.id === id);
                    if (img) {
                        openModal(img.data);
                    }
                });
                
                // Remove button handler
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseFloat(removeBtn.getAttribute('data-id'));
                    removeImage(id);
                });
            });

            updateButtons();
        }

        // Show sections after upload
        function showSections() {
            if (images.length > 0) {
                locationSection.style.display = 'block';
                dateSection.style.display = 'block';
                actionsSection.style.display = 'block';
                
                // Initialize map if not already done
                if (!map) {
                    setTimeout(initMap, 100);
                }
            }
        }

        // Remove single image
        function removeImage(id) {
            images = images.filter(img => img.id !== id);
            renderImages();
            updateButtons();
            showStatus('Image removed', 'success');
        }

        // Remove selected images
        removeBtn.addEventListener('click', () => {
            const selectedCount = images.filter(img => img.selected).length;
            if (selectedCount === 0) {
                showStatus('No images selected to remove', 'error');
                return;
            }
            
            images = images.filter(img => !img.selected);
            lastSelectedIndex = -1;
            renderImages();
            updateButtons();
            showStatus(`Removed ${selectedCount} image(s)`, 'success');
        });

        // Select all images
        selectAllBtn.addEventListener('click', () => {
            images.forEach(img => img.selected = true);
            renderImages();
            updateButtons();
        });

        // Deselect all images
        deselectAllBtn.addEventListener('click', () => {
            images.forEach(img => img.selected = false);
            lastSelectedIndex = -1;
            renderImages();
            updateButtons();
        });

        // Modal functions
        function openModal(imageSrc) {
            modalImage.src = imageSrc;
            imageModal.classList.add('active');
        }

        function closeModal() {
            imageModal.classList.remove('active');
            modalImage.src = '';
        }

        modalClose.addEventListener('click', closeModal);
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && imageModal.classList.contains('active')) {
                closeModal();
            }
        });

        // Initialize map
        function initMap() {
            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map = L.map('map').setView([lat, lng], 13);
                        addMapLayers();
                    },
                    (error) => {
                        // Fallback to default location if geolocation fails
                        console.log('Geolocation error:', error);
                        map = L.map('map').setView([40.7128, -74.0060], 10);
                        addMapLayers();
                    }
                );
            } else {
                // Fallback if geolocation is not supported
                map = L.map('map').setView([40.7128, -74.0060], 10);
                addMapLayers();
            }
        }

        function addMapLayers() {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', (e) => {
                selectedLocation = e.latlng;
                
                if (marker) {
                    map.removeLayer(marker);
                }
                
                marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
                
                coordinatesDisplay.style.display = 'block';
                coordinatesDisplay.textContent = `Latitude: ${e.latlng.lat.toFixed(6)}, Longitude: ${e.latlng.lng.toFixed(6)}`;
                
                updateButtons();
            });
        }

        // Update button states
        function updateButtons() {
            const hasSelectedImages = images.some(img => img.selected);
            const hasLocation = selectedLocation !== null;
            const hasDate = dateInput.value !== '';
            
            applyBtn.disabled = !hasSelectedImages || (!hasLocation && !hasDate);
            downloadBtn.disabled = !hasSelectedImages;
            removeBtn.disabled = !hasSelectedImages;
        }

        // Apply changes
        applyBtn.addEventListener('click', () => {
            const selectedImages = images.filter(img => img.selected);
            
            if (selectedImages.length === 0) {
                showStatus('Please select at least one image', 'error');
                return;
            }

            selectedImages.forEach(img => {
                try {
                    const exifObj = piexif.load(img.data);
                    
                    // Update GPS data if location is selected
                    if (selectedLocation) {
                        const lat = selectedLocation.lat;
                        const lng = selectedLocation.lng;
                        
                        const latDeg = Math.abs(lat);
                        const latMin = (latDeg % 1) * 60;
                        const latSec = (latMin % 1) * 60;
                        
                        const lngDeg = Math.abs(lng);
                        const lngMin = (lngDeg % 1) * 60;
                        const lngSec = (lngMin % 1) * 60;
                        
                        exifObj['GPS'] = {
                            [piexif.GPSIFD.GPSLatitude]: [
                                [Math.floor(latDeg), 1],
                                [Math.floor(latMin), 1],
                                [Math.round(latSec * 100), 100]
                            ],
                            [piexif.GPSIFD.GPSLatitudeRef]: lat >= 0 ? 'N' : 'S',
                            [piexif.GPSIFD.GPSLongitude]: [
                                [Math.floor(lngDeg), 1],
                                [Math.floor(lngMin), 1],
                                [Math.round(lngSec * 100), 100]
                            ],
                            [piexif.GPSIFD.GPSLongitudeRef]: lng >= 0 ? 'E' : 'W'
                        };
                    }
                    
                    // Update date if selected
                    if (dateInput.value) {
                        const dateStr = `${dateInput.value.replace(/-/g, ':')} ${timeInput.value || '00:00'}:00`;
                        exifObj['Exif'][piexif.ExifIFD.DateTimeOriginal] = dateStr;
                        exifObj['0th'][piexif.ImageIFD.DateTime] = dateStr;
                    }
                    
                    const exifBytes = piexif.dump(exifObj);
                    img.data = piexif.insert(exifBytes, img.data);
                    img.modified = true;
                } catch (error) {
                    console.error('Error updating EXIF:', error);
                }
            });
            
            renderImages();
            showStatus(`Successfully updated ${selectedImages.length} image(s)`, 'success');
        });

        // Download selected images
        downloadBtn.addEventListener('click', () => {
            const selectedImages = images.filter(img => img.selected);
            
            if (selectedImages.length === 0) {
                showStatus('Please select at least one image', 'error');
                return;
            }

            selectedImages.forEach(img => {
                const link = document.createElement('a');
                link.href = img.data;
                link.download = img.name;
                link.click();
            });
            
            showStatus(`Downloaded ${selectedImages.length} image(s)`, 'success');
        });

        // Show status message
        function showStatus(message, type) {
            statusMessage.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // Listen to date/time changes
        dateInput.addEventListener('change', updateButtons);
        timeInput.addEventListener('change', updateButtons);
    </script>
</body>
</html>